import 'package:flutter/material.dart';
import 'package:provider/provider.dart';
import 'package:flutter_animate/flutter_animate.dart';
import 'package:confetti/confetti.dart';
import 'package:go_router/go_router.dart';
import 'package:google_fonts/google_fonts.dart';

import '../../providers/game_provider.dart';
import '../../providers/auth_provider.dart';

class QuizScreen extends StatefulWidget {
  final String mode;
  final String? roomCode;
  final int? questionCount;

  const QuizScreen({
    super.key,
    required this.mode,
    this.roomCode,
    this.questionCount,
  });

  @override
  State<QuizScreen> createState() => _QuizScreenState();
}

class _QuizScreenState extends State<QuizScreen>
    with SingleTickerProviderStateMixin {
  late ConfettiController _confettiController;
  late AnimationController _animationController;
  String? _selectedAnswer;
  String? _correctAnswer; // Store the correct answer for current question
  bool _isAnswered = false;
  bool _showCorrectFeedback = false;
  bool _showIncorrectFeedback = false;
  int _currentQuestionIndex = -1; // Track which question we're displaying

  @override
  void initState() {
    super.initState();
    _confettiController = ConfettiController(duration: const Duration(seconds: 3));
    _animationController = AnimationController(
      vsync: this,
      duration: const Duration(milliseconds: 500),
    );

    // Load and start game
    WidgetsBinding.instance.addPostFrameCallback((_) {
      final gameProvider = Provider.of<GameProvider>(context, listen: false);
      gameProvider.loadQuestions().then((_) {
        gameProvider.loadMessages();
        // Use custom question count if provided (for multiplayer)
        if (widget.questionCount != null) {
          gameProvider.startGame(questionCount: widget.questionCount);
        } else {
          gameProvider.startGame();
        }
      });
    });
  }

  @override
  void dispose() {
    _confettiController.dispose();
    _animationController.dispose();
    super.dispose();
  }

  void _handleAnswer(String answer, GameProvider gameProvider) {
    if (_isAnswered) return;

    setState(() {
      _selectedAnswer = answer;
      _isAnswered = true;
    });

    final isCorrect = gameProvider.answerQuestion(answer);

    setState(() {
      if (isCorrect) {
        _showCorrectFeedback = true;
        _confettiController.play();
      } else {
        _showIncorrectFeedback = true;
      }
    });

    _animationController.forward();

    // Wait for animation then move to next question
    Future.delayed(const Duration(milliseconds: 1500), () {
      if (!mounted) return;
      
      if (gameProvider.currentQuestionIndex < gameProvider.totalQuestions - 1) {
        // First reset the question state, then update provider
        setState(() {
          _selectedAnswer = null;
          _isAnswered = false;
          _showCorrectFeedback = false;
          _showIncorrectFeedback = false;
        });
        _animationController.reset();
        
        // Update game provider which will trigger a rebuild with new question
        gameProvider.nextQuestion();
      } else {
        // Game finished
        _navigateToResults(gameProvider);
      }
    });
  }

  void _resetQuestion() {
    if (!mounted) return;
    setState(() {
      _selectedAnswer = null;
      _isAnswered = false;
      _showCorrectFeedback = false;
      _showIncorrectFeedback = false;
    });
    _animationController.reset();
  }

  void _navigateToResults(GameProvider gameProvider) {
    if (widget.mode == 'multiplayer' && widget.roomCode != null) {
      // Navigate to multiplayer leaderboard
      context.go('/multiplayer-result/${widget.roomCode}', extra: {
        'score': gameProvider.score,
        'correctAnswers': gameProvider.correctAnswers,
        'totalQuestions': gameProvider.totalQuestions,
        'timeTaken': gameProvider.getTimeTaken(),
      });
    } else {
      // Navigate to single player result
      context.go('/result', extra: {
        'score': gameProvider.score,
        'correctAnswers': gameProvider.correctAnswers,
        'totalQuestions': gameProvider.totalQuestions,
        'timeTaken': gameProvider.getTimeTaken(),
        'mode': widget.mode,
      });
    }
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      body: Stack(
        children: [
          // Background Gradient
          Container(
            decoration: const BoxDecoration(
              gradient: LinearGradient(
                begin: Alignment.topLeft,
                end: Alignment.bottomRight,
                colors: [
                  Color(0xFF0F0F1A),
                  Color(0xFF1A0033),
                  Color(0xFF0F0F1A),
                ],
                stops: [0.0, 0.5, 1.0],
              ),
            ),
          ),
          
          // Confetti
          Align(
            alignment: Alignment.topCenter,
            child: ConfettiWidget(
              confettiController: _confettiController,
              blastDirectionality: BlastDirectionality.explosive,
              shouldLoop: false,
              colors: const [
                Colors.green,
                Colors.blue,
                Colors.pink,
                Colors.orange,
                Colors.purple
              ],
            ),
          ),

          // Content
          SafeArea(
            child: Consumer2<GameProvider, AuthProvider>(
              builder: (context, gameProvider, authProvider, child) {
                if (gameProvider.currentQuestion == null) {
                  return const Center(
                    child: CircularProgressIndicator(color: Colors.white),
                  );
                }

                final question = gameProvider.currentQuestion!;
                
                // Update correct answer when question changes
                if (_currentQuestionIndex != gameProvider.currentQuestionIndex) {
                  _currentQuestionIndex = gameProvider.currentQuestionIndex;
                  _correctAnswer = question.correctAnswer;
                }

                return Column(
                  children: [
                    // Header
                    _buildHeader(gameProvider, authProvider),
                    
                    const SizedBox(height: 20),
                    
                    // Question Card
                    Expanded(
                      child: Center(
                        child: SingleChildScrollView(
                          padding: const EdgeInsets.all(20),
                          child: Column(
                            mainAxisAlignment: MainAxisAlignment.center,
                            children: [
                              // Question Counter
                              Text(
                                'Question ${gameProvider.currentQuestionIndex + 1}/${gameProvider.totalQuestions}',
                                style: GoogleFonts.montserrat(
                                  color: const Color(0xFFFFD60A),
                                  fontSize: 18,
                                  fontWeight: FontWeight.bold,
                                  letterSpacing: 1,
                                ),
                              ).animate().fadeIn().slideY(
                                duration: 400.ms,
                                begin: -0.2,
                                curve: Curves.easeOut,
                              ),
                              
                              const SizedBox(height: 30),
                              
                              // Question Text
                              Container(
                                padding: const EdgeInsets.all(24),
                                decoration: BoxDecoration(
                                  gradient: LinearGradient(
                                    colors: [
                                      const Color(0xFF667eea).withOpacity(0.3),
                                      const Color(0xFF764ba2).withOpacity(0.3),
                                    ],
                                  ),
                                  borderRadius: BorderRadius.circular(20),
                                  border: Border.all(
                                    color: const Color(0xFF5B4EFF).withOpacity(0.5),
                                    width: 2,
                                  ),
                                  boxShadow: [
                                    BoxShadow(
                                      color: const Color(0xFF5B4EFF).withOpacity(0.3),
                                      blurRadius: 20,
                                      offset: const Offset(0, 10),
                                    ),
                                  ],
                                ),
                                child: Text(
                                  question.question,
                                  style: GoogleFonts.bungee(
                                    fontSize: 24,
                                    color: Colors.white,
                                    height: 1.4,
                                  ),
                                  textAlign: TextAlign.center,
                                ),
                              ).animate().fadeIn().scale(
                                duration: 500.ms,
                                curve: Curves.easeOut,
                              ),
                              
                              const SizedBox(height: 40),
                              
                              // Answer Options
                              Column(
                                children: [
                                  _buildAnswerButton(
                                    'A',
                                    question.optionA,
                                    gameProvider,
                                  ),
                                  const SizedBox(height: 20),
                                  _buildAnswerButton(
                                    'B',
                                    question.optionB,
                                    gameProvider,
                                  ),
                                ],
                              ),
                            ],
                          ),
                        ),
                      ),
                    ),
                  ],
                );
              },
            ),
          ),

          // Feedback Overlays
          if (_showCorrectFeedback)
            _buildFeedbackOverlay(
              icon: Icons.check_circle,
              color: Colors.green,
              text: 'Correct!',
            ),
          if (_showIncorrectFeedback)
            _buildFeedbackOverlay(
              icon: Icons.cancel,
              color: Colors.red,
              text: 'Incorrect!',
            ),
        ],
      ),
    );
  }

  Widget _buildHeader(GameProvider gameProvider, AuthProvider authProvider) {
    return Container(
      padding: const EdgeInsets.all(16),
      child: Row(
        mainAxisAlignment: MainAxisAlignment.spaceBetween,
        children: [
          // Back Button
          IconButton(
            icon: const Icon(Icons.arrow_back, color: Colors.white),
            onPressed: () => context.go('/home'),
          ),
          
          // Play Attempts (Hearts)
          if (widget.mode == 'single')
            Container(
              padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 6),
              decoration: BoxDecoration(
                gradient: const LinearGradient(
                  colors: [Color(0xFFFF2D55), Color(0xFFFF6B9D)],
                ),
                borderRadius: BorderRadius.circular(20),
                boxShadow: [
                  BoxShadow(
                    color: const Color(0xFFFF2D55).withOpacity(0.5),
                    blurRadius: 10,
                    offset: const Offset(0, 0),
                  ),
                ],
              ),
              child: Row(
                children: [
                  const Icon(Icons.favorite, color: Colors.white, size: 20),
                  const SizedBox(width: 8),
                  Text(
                    '${authProvider.user?.playAttempts ?? 0}',
                    style: GoogleFonts.montserrat(
                      color: Colors.white,
                      fontSize: 18,
                      fontWeight: FontWeight.bold,
                    ),
                  ),
                ],
              ),
            ),
          
          // Score
          Container(
            padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 6),
            decoration: BoxDecoration(
              gradient: const LinearGradient(
                colors: [Color(0xFFFFD60A), Color(0xFFFFA500)],
              ),
              borderRadius: BorderRadius.circular(20),
              boxShadow: [
                BoxShadow(
                  color: const Color(0xFFFFD60A).withOpacity(0.5),
                  blurRadius: 10,
                  offset: const Offset(0, 0),
                ),
              ],
            ),
            child: Row(
              children: [
                const Icon(Icons.star, color: Colors.white, size: 20),
                const SizedBox(width: 8),
                Text(
                  '${gameProvider.score}',
                  style: GoogleFonts.montserrat(
                    color: Colors.white,
                    fontSize: 18,
                    fontWeight: FontWeight.bold,
                  ),
                ),
              ],
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildAnswerButton(
    String option,
    String text,
    GameProvider gameProvider,
  ) {
    final isSelected = _selectedAnswer == option;
    final isCorrect = option == _correctAnswer;
    
    Gradient? buttonGradient;
    Color? solidColor;
    Color shadowColor = const Color(0xFF5B4EFF);
    
    if (_isAnswered) {
      if (isSelected) {
        if (isCorrect) {
          buttonGradient = const LinearGradient(
            colors: [Color(0xFF00F2FF), Color(0xFF4FACFE)],
          );
          shadowColor = const Color(0xFF00F2FF);
        } else {
          buttonGradient = const LinearGradient(
            colors: [Color(0xFFFF2D55), Color(0xFFFF6B9D)],
          );
          shadowColor = const Color(0xFFFF2D55);
        }
      } else if (isCorrect) {
        solidColor = const Color(0xFF00F2FF).withOpacity(0.3);
        shadowColor = const Color(0xFF00F2FF);
      } else {
        solidColor = Colors.white.withOpacity(0.1);
      }
    } else {
      solidColor = Colors.white.withOpacity(0.1);
    }

    return GestureDetector(
      onTap: _isAnswered ? null : () => _handleAnswer(option, gameProvider),
      child: AnimatedContainer(
        duration: _isAnswered ? const Duration(milliseconds: 300) : Duration.zero,
        curve: Curves.easeInOut,
        padding: const EdgeInsets.all(20),
        decoration: BoxDecoration(
          gradient: buttonGradient,
          color: solidColor,
          borderRadius: BorderRadius.circular(16),
          border: Border.all(
            color: isSelected && !_isAnswered 
                ? const Color(0xFFFFD60A)
                : (_isAnswered ? Colors.transparent : Colors.white.withOpacity(0.3)),
            width: 2,
          ),
          boxShadow: [
            BoxShadow(
              color: shadowColor.withOpacity(_isAnswered && isSelected ? 0.6 : 0.2),
              blurRadius: _isAnswered && isSelected ? 20 : 10,
              offset: const Offset(0, 5),
            ),
          ],
        ),
        child: Row(
          children: [
            // Option Letter
            Container(
              width: 50,
              height: 50,
              decoration: BoxDecoration(
                color: Colors.white.withOpacity(0.2),
                shape: BoxShape.circle,
                border: Border.all(
                  color: Colors.white.withOpacity(0.3),
                  width: 2,
                ),
              ),
              child: Center(
                child: Text(
                  option,
                  style: GoogleFonts.montserrat(
                    color: Colors.white,
                    fontSize: 24,
                    fontWeight: FontWeight.bold,
                  ),
                ),
              ),
            ),
            const SizedBox(width: 16),
            
            // Option Text
            Expanded(
              child: Text(
                text,
                style: GoogleFonts.montserrat(
                  fontSize: 18,
                  fontWeight: FontWeight.w600,
                  color: Colors.white,
                ),
              ),
            ),
            
            // Feedback Icon
            if (_isAnswered && isSelected)
              Icon(
                isCorrect ? Icons.check_circle : Icons.cancel,
                color: Colors.white,
                size: 30,
              ),
          ],
        ),
      ),
    ).animate().then(delay: 200.ms)
     .fadeIn(duration: 400.ms)
     .slideX(begin: -0.1, end: 0);
  }

  Widget _buildFeedbackOverlay({
    required IconData icon,
    required Color color,
    required String text,
  }) {
    return Container(
      color: color.withOpacity(0.3),
      child: Center(
        child: Container(
          padding: const EdgeInsets.all(40),
          decoration: BoxDecoration(
            color: Colors.white,
            shape: BoxShape.circle,
            boxShadow: [
              BoxShadow(
                color: color.withOpacity(0.5),
                blurRadius: 30,
                spreadRadius: 10,
              ),
            ],
          ),
          child: Column(
            mainAxisSize: MainAxisSize.min,
            children: [
              Icon(icon, size: 80, color: color),
              const SizedBox(height: 10),
              Text(
                text,
                style: TextStyle(
                  fontSize: 24,
                  fontWeight: FontWeight.bold,
                  color: color,
                ),
              ),
            ],
          ),
        ).animate().scale(
          duration: 400.ms,
          curve: Curves.elasticOut,
        ),
      ),
    );
  }
}
